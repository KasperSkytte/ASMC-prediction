---
title: "analysis"
author: "KSA"
date: "9/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE
)
require("patchwork")
require("data.table")
require("ampvis2")
require("magrittr")
require("stringr")
```

```{r}
library(data.table)
library(stringi)

read_results <- function(results_dir) {
  parse_performance <- function(file) {
    if (!file.exists(file)) {
      warning("file ", file, " doesn't exist, skipping...")
      return(NULL)
    }

    dt <- fread(file)
    colnames(dt) <- stringi::stri_replace_all_regex(
      colnames(dt),
      pattern = "[\\[\\'\\]]",
      replacement = ""
    )

    dt[] <- lapply(
      dt,
      stringi::stri_replace_all_regex,
      pattern = "^[^\\[]*\\[|\\]$",
      replacement = ""
    )
    dt[] <- lapply(dt, as.numeric)

    dt <- melt(
      dt,
      id.vars = NULL,
      measure.vars = 1:3,
      variable.name = "error_metric",
      value = "value"
    )

    return(dt)
  }
  filenames <- c(
    "lstm_idec_performance.txt",
    "lstm_abund_performance.txt",
    "lstm_func_performance.txt"
  )

  results_list <- lapply(
    paste0(results_dir, "/", filenames),
    parse_performance
  )
  names(results_list) <- gsub("_performance.txt$", "", filenames)

  dt <- rbindlist(results_list, idcol = "cluster_type")

  logfile <- fread(
    list.files(
      results_dir,
      pattern = "log_[0-9]*_[0-9]*\\.txt",
      full.names = T
    ),
    sep = "\n",
    header = FALSE,
    col.names = "line"
  )

  dt[
    ,
    dataset := basename(
      gsub(
        "\\/ASVtable.*$",
        "",
        logfile[grepl(".*ASVtable.*", line), line]
      )
    )
  ]

  return(dt)
}

#list results folder and gogo
runs <- list.files(".", pattern = "^results_.*",  full.names = TRUE)
if (length(runs) == 0) {
  stop("No results folders found, wrong working directory?")
}
d_list <- lapply(runs, read_results)
names(d_list) <- basename(runs)
d <- rbindlist(d_list, idcol = "results_folder", fill = TRUE)[!is.na(cluster_type)]
d
d[
  ,
  cluster_type := stringr::str_replace_all(
    cluster_type,
    pattern = c(
      "lstm_abund" = "Single ASV",
      "lstm_func" = "Biological function",
      "lstm_idec" = "IDEC"
    )
  )
]
d[
  ,
  error_metric := stringr::str_replace_all(
    error_metric,
    pattern = c(
      "bray-curtis" = "Bray Curtis",
      "mean_squared_error" = "Mean Squared Error (MSE)",
      "mean_absolute_error" = "Mean Absolute Error (MAE)"
    )
  )
]
```


```{r}
tablename <- "performance_table"

plot_performance <- function(path) {
  filenames <- c("lstm_idec_performance.txt", "lstm_abund_performance.txt", "lstm_func_performance.txt")
  list <- lapply(paste0(path, "/", filenames), function(filepath) {
    dt <- fread(filepath)
    colnames(dt) <- gsub("[\\['\\]]*", "", colnames(dt))
    dt[, cluster := gsub(":.*$", "", `bray-curtis`)]
    dt <- dt[,lapply(.SD, gsub, pattern = "^[0-9]+:.*\\[|\\]$", replacement = "")]
    dt <- dt[,lapply(.SD, as.numeric)]
    dt <- melt(dt, id.vars = "cluster", variable.name = "errorfunc", value.name = "value")
    dt[, clustertype := tools::file_path_sans_ext(basename(filepath))]
    dt[, name := basename(path)]
    dt
  })
  dt <- rbindlist(list)
  if (!exists(tablename, .GlobalEnv)) {
    assign(tablename, dt, .GlobalEnv)
  } else {
    assign(tablename, rbindlist(list(get(tablename, .GlobalEnv), dt)), .GlobalEnv)
  }
  plot <- ggplot(
    dt,
    aes(
      x = cluster,
      y = value,
      group = clustertype,
      color = clustertype,
      fill = clustertype
    )
  ) +
    geom_col(position = "dodge2") +
    facet_wrap("errorfunc", scales = "free_y", ncol = 1) +
    ylim(0, 1)
  print(plot)
  cli::cat_line(readLines(paste0(path, "/idec_performance.txt")))
}

read_16sdata <- function(path) {
  abund <- fread(paste0(path, "/data_reformatted/abundances.csv"))
  metadata <- fread(paste0(path, "/data_reformatted/metadata.csv"))[, -c("Plant")]
  asvtable <- metadata[abund, , on = "SampleID"]
  melt(
    asvtable,
    id.vars = c("SampleID", "Date"),
    variable.name = "ASV",
    value.name = "abundance",
    variable.factor = FALSE)
}
```

```{r, fig.width = 12, fig.height = 10}
plot <- ggplot(
  d[value > 0],
  aes(
    cluster_type,
    value,
    color = cluster_type
  )
) +
  geom_boxplot() +
  facet_grid(
    rows = vars(error_metric),
    cols = vars(dataset), scales = "free_y"
  ) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    legend.title = element_blank(),
    axis.title = element_blank()
  ) +
  scale_color_discrete(
    labels = c(
      lstm_idec = "IDEC",
      lstm_func = "Metab. function",
      lstm_abund = "Single ASV"
    )
  )

plot

ggsave(
  "results_all.png",
  plot = plot,
  width = 14,
  height = 8
)
```

```{r}
#abundance tables
read_abund <- function(dir, pattern, sample_prefix = "") {
  predicted_abund_files <- list.files(
    dir,
    pattern = pattern,
    recursive = FALSE,
    include.dirs = FALSE,
    full.names = TRUE
  )
  predicted_abund_list <- lapply(
    predicted_abund_files,
    function(file) {
      #first read each file
      file <- fread(
        file,
        sep = ",",
        header = TRUE
      )

      #melt to be able to row bind all files
      abund <- melt(
        file,
        id.vars = "Sample",
        variable.name = "OTU",
        value.name = "abundance"
      )
      abund[[1]] <- paste0(sample_prefix, abund[[1]])
      return(abund)
    }
  )

  abund <- dcast(
    rbindlist(
      predicted_abund_list
    ),
    OTU~Sample,
    value.var = "abundance"
  )

  return(abund)
}

pred_abund <- read_abund(
  dir = "results_20220420_163047/data_predicted/",
  pattern = "lstm_abund.*predicted\\.csv",
  sample_prefix = "pred_"
)
true_abund <- read_abund(
  dir = "results_20220420_163047/data_predicted/",
  pattern = "lstm_abund.*dataall\\.csv",
  sample_prefix = "true_"
)

#metadata
metadata_files <- list.files(
  "results_20220420_163047/data_predicted/",
  pattern = "lstm_abund.*dates\\.csv",
  recursive = FALSE,
  include.dirs = FALSE,
  full.names = TRUE
)
#dates per sample are the same for all
#just use the first file as metadata for all
metadata <- fread(metadata_files[[1]])

#load and combine data sets
predicted_data <- amp_load(
  otutable = pred_abund,
  metadata = metadata[, .(Sample = paste0("pred_", Sample), Date)]
)
true_data <- amp_load(
  otutable = true_abund,
  metadata = metadata[, .(Sample = paste0("true_", Sample), Date)]
)

combined <- amp_merge
```

```{r}
otutable <- as.data.frame(t(fread("results_20220420_163047/data_reformatted/abundances.csv", data.table = FALSE)))
colnames(otutable) <- otutable[1, ]
otutable <- otutable[-1, ]
otutable[] <- lapply(otutable, as.numeric)

actual <- amp_load(
  otutable = otutable,
  metadata = "results_20220420_163047/data_reformatted/metadata.csv",
  taxonomy = "results_20220420_163047/data_reformatted/taxonomy_wfunctions.csv"
)
amp_timeseries(
  amp_subset_taxa(actual, "ASV1; s__midas_s_5; g__Tetrasphaera", normalise = FALSE),
  time_variable = "Date",
  normalise = FALSE
)
```